name: OnBoarding Usuarios
run-name: ¡Estoy ejecutando pruebas de onboarding!
on:
  workflow_dispatch:
    inputs:
      username:
        description: "GitHub username a invitar (sin @)"
        required: true
        type: string
      org:
        description: "Nombre de la organización"
        required: true
        type: string
      team:
        description: "Nombre del team en la organización"
        required: true
        type: string
      repo:
        description: "Repositorio destino para asignar permisos (nombre)"
        required: true
        type: string
      permission:
        description: "Permiso en repo: pull, triage, push, maintain, admin"
        required: true
        default: "push"
        type: string

jobs:
  onboarding:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      issues: write
    steps:
     - name: Auth gh con token
       env:
          GH_TOKEN1: ${{ secrets.GH_TOKEN }}
       run: |
          echo "$GH_TOKEN1" | gh auth login --with-token
         
     - name: Invitar usuario a la organización (si no es miembro)
       env:
          ORG: ${{ inputs.org }}
       run: |
          USER="${{ inputs.username }}"
          # Invitar por nombre de usuario (si no pertenece ya)
          MEMBERSHIP=$(gh api /orgs/$ORG/members/$USER -q . >/dev/null 2>&1 || echo "not_member")
          if [ "$MEMBERSHIP" = "not_member" ]; then
            echo "Invitando $USER a $ORG"
            
            INVITEE_ID=$(gh api users/$USER | jq -r '.id')
            gh api --method POST /orgs/$ORG/invitations \
            --input - <<< "{\"invitee_id\": $INVITEE_ID, \"role\": \"direct_member\"}" || true
           
          else
            echo "$USER ya es miembro o no se pudo comprobar membership; continuamos"
          fi
          
     - name: Agregar usuario al equipo
       env:
          ORG: ${{ inputs.org }}
          USER: ${{ inputs.username }}
          TEAM_INPUT: ${{ inputs.team }}
       run: |       
          TEAM_SLUG=$(gh api /orgs/$ORG/teams --paginate \
          --jq ".[] | select(.slug==\"$TEAM_INPUT\" or .name==\"$TEAM_INPUT\") | .slug")
          
          echo "- Slug del equipo encontrado: $TEAM_SLUG"
          
          if [ -z "$TEAM_SLUG" ]; then
            echo "ERROR: El equipo '$TEAM_INPUT' no existe en la organización '$ORG'."
            echo "Equipos disponibles:"
            gh api /orgs/$ORG/teams --jq '.[].slug'
            exit 1
          fi
          echo "Agregando usuario @$USER al equipo $TEAM_SLUG..."
          
          # 3. Esperar hasta que el usuario acepte la invitación
          echo "** Verificando si $USER ya aceptó la invitación..."
          for i in {1..10}; do
            STATUS=$(gh api /orgs/$ORG/members/$USER -q . >/dev/null 2>&1 && echo "accepted" || echo "pending")
            if [ "$STATUS" = "accepted" ]; then
              echo "$USER ya es miembro confirmado"
            break
            fi
            echo "**Invitación aún pendiente, esperando 30s..."
            sleep 30
          done

          if [ "$STATUS" != "accepted" ]; then
            echo "El usuario $USER aún no aceptó la invitación. No se puede agregar al equipo."
            exit 0
          fi
          
          # 4. Agregar al equipo
          echo "Agregando $USER al equipo $TEAM_NAME ($TEAM_SLUG)"
          gh api --method PUT /orgs/$ORG/teams/$TEAM_SLUG/memberships/$USER -f role=member
          echo "$USER agregado correctamente al equipo"

     - name: Asignar permisos en repositorio
       env:
          ORG: ${{ inputs.org }}
          TEAM_INPUT: ${{ inputs.team }}
          REPO: ${{ inputs.repo }}
          PERMISSION: ${{ inputs.permission }}
       run: |
         set -euo pipefail

          echo "Validando repo '$REPO' en la organización '$ORG'..."

          # Validar repo
          if ! gh api "/repos/$ORG/$REPO" >/dev/null 2>&1; then
            echo "ERROR: El repositorio '$REPO' no existe en la organización '$ORG'."
            echo "Repos disponibles:"
            gh api "/orgs/$ORG/repos" --paginate --jq '.[].name'
            exit 1
          fi
          echo "Repositorio encontrado: $REPO"

          # Buscar slug del equipo
          TEAM_SLUG=$(gh api "/orgs/$ORG/teams" --paginate \
            --jq ".[] | select(.slug==\"$TEAM_INPUT\" or .name==\"$TEAM_INPUT\") | .slug")

          if [ -z "$TEAM_SLUG" ]; then
            echo "ERROR: El equipo '$TEAM_INPUT' no existe en la organización '$ORG'."
            echo "Equipos disponibles:"
            gh api "/orgs/$ORG/teams" --jq '.[].slug'
            exit 1
          fi
          echo "Equipo encontrado: $TEAM_SLUG"

          # Asignar permisos
          echo "Asignando permiso '$PERMISSION' al equipo '$TEAM_SLUG' en el repo '$REPO'..."
          gh api --method PUT "/orgs/$ORG/teams/$TEAM_SLUG/repos/$ORG/$REPO" -f permission=$PERMISSION
          echo "Permiso '$PERMISSION' asignado exitosamente."
 
     - name: Crear issue de bienvenida
       env:
          ORG: ${{ inputs.org }}
       run: |
          gh issue create --repo $ORG/${{ inputs.repo }} --title "Bienvenido @${{ inputs.username }}!" \
            --body "Hola @${{ inputs.username }}\n\n Bienvenido a **${{ inputs.team }}**. Aquí tienes:\n- Repo: ${{ inputs.repo }}\n- Permiso: ${{ inputs.permission }}\n\n Si necesitas acceso adicional, abre un ticket." || true
          
          
     
     
      
