name: Pruebas Offboarding Usuarios
run-name: Pruebas de baja de usuarios!
on:
  workflow_dispatch:
    inputs:
      username:
        description: "GitHub username a remover (sin @)"
        required: true
        type: string
      repo:
        description: "Repositorio para registrar auditor√≠a"
        required: true
        type: string
      remove_from_org:
        description: "Eliminar de la org? (yes/no)"
        required: false
        default: "no"
        type: string

jobs:
  remove-user-from-teams:
    runs-on: ubuntu-latest
    steps:
      - name: Remover usuario de todos los teams
        env:
          ORG: ${{ github.repository_owner }}   # üëà tu organizaci√≥n
          USER: ${{ inputs.username }}    # üëà el usuario que quieres remover
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          set -e

          echo "üîé Verificando si $USER es miembro de la organizaci√≥n $ORG..."
          if ! gh api orgs/$ORG/members/$USER >/dev/null 2>&1; then
            echo "‚ö†Ô∏è El usuario $USER no es miembro de la organizaci√≥n $ORG"
            exit 0
          fi

          echo "üìã Listando equipos en la organizaci√≥n $ORG..."
          teams=$(gh api /orgs/$ORG/teams --jq '.[].slug')

          if [ -z "$teams" ]; then
            echo "‚ö†Ô∏è No se encontraron equipos en la organizaci√≥n $ORG"
            exit 0
          fi

          for team in $teams; do
            echo "üîé Verificando si $USER pertenece al team $team..."
            if gh api /orgs/$ORG/teams/$team/memberships/$USER >/dev/null 2>&1; then
              echo "üóëÔ∏è Removiendo $USER del team $team"
              gh api --method DELETE /orgs/$ORG/teams/$team/memberships/$USER || true
            else
              echo "‚ÑπÔ∏è $USER no est√° en el team $team"
            fi
          done
