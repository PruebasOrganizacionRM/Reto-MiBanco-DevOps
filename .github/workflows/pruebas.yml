name: Pruebas usando variables
run-name: ¬°Estoy probando variables a usar Variables!
on:
  workflow_dispatch:
    inputs:
      username:
        description: "GitHub username a invitar (sin @)"
        required: true
        type: string
      team:
        description: "Nombre del team en la organizaci√≥n"
        required: true
        type: string
      repo:
        description: "Repositorio destino para asignar permisos (nombre)"
        required: true
        type: string
      permission:
        description: "Permiso en repo: pull, triage, push, maintain, admin"
        required: true
        default: "push"
        type: string

jobs:
  onboarding:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
      issues: write
    steps:
     - name: Auth gh con token
       env:
          GH_TOKEN1: ${{ secrets.GH_TOKEN }}
       run: |
          echo "$GH_TOKEN1" | gh auth login --with-token
     - name: Obtener ID de usuario (si existe)
       id: userid
       run: |
          set -e
          USER="${{ inputs.username }}"
          # Si no existe, 'gh api users/...' fallar√°. Manejamos la salida.
          if gh api users/$USER --jq '.id' >/dev/null 2>&1; then
            echo "id=$(gh api users/$USER --jq '.id')" >> "$GITHUB_OUTPUT"
          else
            echo "id=" >> "$GITHUB_OUTPUT"
          fi
     - name: Usar el ID en otro paso
       run: |
          echo "El ID del usuario es: ${{ steps.userid.outputs.id }}"
     - name: Invitar usuario a la organizaci√≥n (si no es miembro)
       env:
          ORG: ${{ inputs.team }}
       run: |
          USER="${{ inputs.username }}"
          # Invitar por nombre de usuario (si no pertenece ya)
          MEMBERSHIP=$(gh api /orgs/$ORG/members/$USER -q . >/dev/null 2>&1 || echo "not_member")
          if [ "$MEMBERSHIP" = "not_member" ]; then
            echo "Invitando $USER a $ORG"
            
            INVITEE_ID=$(gh api users/$USER | jq -r '.id')

            echo "id 1 -> $INVITEE_ID **"
            echo "id 2 -> $INVITEE_ID1 **"
            echo "id 3 -> $INVITEE_ID2 **"

            gh api --method POST /orgs/$ORG/invitations \
            --input - <<< "{\"invitee_id\": $INVITEE_ID, \"role\": \"direct_member\"}" || true
           
          else
            echo "$USER ya es miembro o no se pudo comprobar membership; continuamos"
          fi
     - name: Agregar usuario al equipo
       env:
          ORG: ${{ inputs.team }}
       run: |
          TEAM_SLUG=$(gh api /orgs/$ORG/teams --jq ".[] | select(.name==\"${{ inputs.team }}\") | .slug")
          if [ -z "$TEAM_SLUG" ]; then
          echo "tam slug -> $TEAM_SLUG "
          echo "‚ùå No se encontr√≥ el equipo con nombre: ${{ inputs.team }}"
          exit 1
          fi
          echo "üìå Slug del equipo encontrado: $TEAM_SLUG"
          gh api --method PUT /orgs/$ORG/teams/${{ inputs.team }}/memberships/${{ inputs.username }} || true
          # 3. Esperar hasta que el usuario acepte la invitaci√≥n
          echo "‚è≥ Verificando si $USER ya acept√≥ la invitaci√≥n..."
          for i in {1..10}; do
            STATUS=$(gh api /orgs/$ORG/members/$USER -q . >/dev/null 2>&1 && echo "accepted" || echo "pending")
            if [ "$STATUS" = "accepted" ]; then
              echo "‚úÖ $USER ya es miembro confirmado"
            break
            fi
            echo "‚åõ Invitaci√≥n a√∫n pendiente, esperando 30s..."
            sleep 30
          done

          if [ "$STATUS" != "accepted" ]; then
            echo "‚ö†Ô∏è El usuario $USER a√∫n no acept√≥ la invitaci√≥n. No se puede agregar al equipo."
            exit 0
          fi

          # 4. Agregar al equipo
          echo "üë• Agregando $USER al equipo $TEAM_NAME ($TEAM_SLUG)"
          gh api --method PUT /orgs/$ORG/teams/$TEAM_SLUG/memberships/$USER -f role=member
          echo "üéâ $USER agregado correctamente al equipo"
     
     
      
