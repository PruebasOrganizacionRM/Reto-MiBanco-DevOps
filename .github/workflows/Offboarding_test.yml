name: Offboarding de usuarios
run-name: baja de usuarios
on:
  workflow_dispatch:
    inputs:
      username:
        description: 'GitHub username del miembro a dar de baja'
        required: true
        type: string
      org:
        description: "Nombre de la organizaci√≥n"
        required: true
        type: string

jobs:
  remove-user:
    runs-on: ubuntu-latest

    steps:
      - name: Configurar GitHub CLI
        run: |
          echo "${{ secrets.GH_TOKEN  }}" | gh auth login --with-token
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN  }}

      - name: Generar auditor√≠a de equipos/repos del usuario
        run: |
          ORG="$${{ inputs.org }}""
          USER="${{ inputs.username }}"

          echo "üìä Generando auditor√≠a de accesos de $USER..."
          echo "### Auditor√≠a de $USER" > auditoria_${USER}.md
          echo "- Organizaci√≥n: $ORG" >> auditoria_${USER}.md
          echo "- Usuario: $USER" >> auditoria_${USER}.md
          echo "- Fecha: $(date)" >> auditoria_${USER}.md
          echo "" >> auditoria_${USER}.md

          echo "üë• Equipos:"
          gh api "/orgs/$ORG/teams" --jq ".[] | select(.members_url | contains(\"$USER\")) | .slug" >> auditoria_${USER}.md || echo "Ninguno" >> auditoria_${USER}.md

          echo "" >> auditoria_${USER}.md
          echo "üìÇ Repositorios (se obtienen por equipos relacionados)" >> auditoria_${USER}.md

          cat auditoria_${USER}.md

      - name: Eliminar usuario de la organizaci√≥n
        run: |
          ORG="$${{ inputs.org }}""
          USER="${{ inputs.username }}"

          echo "üóë Eliminando a $USER de la organizaci√≥n $ORG..."
          gh api --method DELETE "/orgs/$ORG/members/$USER" || echo "‚ÑπÔ∏è Usuario ya no est√° en la organizaci√≥n"
          echo "‚úÖ Baja completada"
